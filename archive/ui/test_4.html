<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Rowing Analysis – Minimal Working Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f4f6fa; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --accent:#2563eb; --accent2:#06b6d4; --good:#22c55e;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:1200px;margin:18px auto 48px;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px}
  h1{font-size:22px;margin:0}
  .chip{padding:.25rem .6rem;border-radius:999px;background:#eef2ff;color:#334155;font-weight:600}

  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media (min-width:980px){.grid{grid-template-columns:3fr 2fr}}

  .card{background:var(--panel);border:1px solid:var(--line);border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,.06);border-color:var(--line)}
  .panel{padding:12px}

  /* Left */
  .videoBox{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
  video,canvas#overlay{position:absolute;inset:0;width:100%;height:100%}
  canvas#overlay{pointer-events:none}

  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:10px 12px;border-top:1px solid var(--line)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#eef2ff;color:#111827;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-color:transparent}
  .select{display:flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .select select{accent-color:var(--accent)}
  .controls .spacer{flex:1}

  .statusCard{margin:12px;border:1px solid var(--line);border-radius:12px}
  .statusRow{display:flex;align-items:center;gap:12px;padding:10px}
  .track{position:relative;height:10px;background:#eef2f7;border-radius:999px;flex:1}
  .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;background:var(--accent);border-radius:50%}
  .tip{padding:10px 12px;color:#1e293b;background:#f0f9ff;border-top:1px solid #dbeafe;border-radius:0 0 12px 12px}

  .chartCard{margin:12px;border:1px solid var(--line);border-radius:12px;padding:10px}
  .legendDots{display:flex;gap:12px;font-size:12px;color:var(--muted)}
  .legendDots span{display:inline-flex;align-items:center;gap:6px}
  .dot{width:8px;height:8px;border-radius:50%}

  /* Right */
  .side{display:flex;flex-direction:column;gap:12px;padding:12px}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .gauge{width:130px;height:130px;position:relative}
  .gauge svg{transform:rotate(-90deg)}
  .gauge .txt{position:absolute;inset:0;display:grid;place-items:center;font-size:28px;font-weight:800}

  .section{border:1px solid var(--line);border-radius:10px;padding:10px}
  .section h3{margin:0 0 8px;font-size:14px}
  .field{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:6px 0}
  .bar{height:8px;background:#eef2f7;border-radius:999px;position:relative;overflow:hidden}
  .bar .fill{position:absolute;inset:0;width:0%;background:linear-gradient(90deg,#22c55e,#a7f3d0)}
  .disabled{opacity:.45;filter:saturate(.2)}
  .mini{height:120px;border:1px dashed var(--line);border-radius:8px;background:#fafafa;display:grid;place-items:center}
  canvas#trace{width:100%;height:100%}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Rowing Analysis</h1>
    <span class="chip">created with rowerup.com</span>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="panel">
        <div class="videoBox" id="videoBox">
          <video id="video" muted autoplay loop playsinline>
            <!-- Optional: add test.mp4 beside this file to see video under the overlay -->
            <source src="test.mp4" type="video/mp4">
          </video>
          <canvas id="overlay"></canvas>
        </div>
      </div>

      <div class="controls">
        <button id="play" class="btn primary">⏸ Pause</button>
        <label class="select">Speed
          <select id="speed">
            <option value="0.5">0.5×</option>
            <option value="0.75">0.75×</option>
            <option value="1" selected>1×</option>
            <option value="1.5">1.5×</option>
            <option value="2">2×</option>
          </select>
        </label>
        <div class="spacer"></div>
        <span style="color:#64748b">Everything updates live without any external data.</span>
      </div>

      <div class="statusCard">
        <div class="statusRow">
          <span style="color:#475569">Stroke status</span>
          <div class="track" id="track"><div class="thumb" id="thumb" style="left:10%"></div></div>
          <span id="clock" style="color:#64748b">0.00s</span>
        </div>
        <div class="tip">
          <strong>AI Tip (beta):</strong> Do a faster <b>Drive</b> and slower <b>Recovery</b>.
        </div>
      </div>

      <div class="chartCard">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <h3 style="margin:0;font-size:15px">Speed &amp; sequence</h3>
          <div class="legendDots">
            <span><span class="dot" style="background:#16a34a"></span>Legs</span>
            <span><span class="dot" style="background:#0ea5e9"></span>Back</span>
            <span><span class="dot" style="background:#f43f5e"></span>Arms</span>
            <span><span class="dot" style="background:#8b5cf6"></span>Handle</span>
          </div>
        </div>
        <canvas id="seq" style="width:100%;height:220px"></canvas>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card side">
      <div class="row">
        <div style="font-size:12px;color:#64748b">Classic style II | spm <span id="spm">22</span></div>
        <div class="gauge">
          <svg viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" fill="none" stroke="#e5e7eb" stroke-width="12"/>
            <circle id="gArc" cx="60" cy="60" r="52" fill="none" stroke="url(#gGrad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="327" stroke-dashoffset="327"/>
            <defs>
              <linearGradient id="gGrad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#22c55e"/><stop offset="100%" stop-color="#86efac"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="txt" id="gText">33%</div>
        </div>
      </div>

      <div class="section">
        <h3>Stroke 3</h3>
        <div style="font-weight:700;margin:6px 0 2px">Finish</div>
        <div class="field"><span>Layback body angle</span><div class="bar"><div id="bLay" class="fill"></div></div><span id="vLay">38°</span></div>
        <div class="field"><span>Legs unbent</span><div class="bar"><div id="bLeg" class="fill"></div></div><span id="vLeg">170°</span></div>
        <div class="field"><span>Handle height at torso</span><div class="bar"><div id="bHan" class="fill"></div></div><span id="vHan">71%</span></div>

        <div class="disabled" style="margin-top:10px">
          <div style="font-weight:700;margin:6px 0 2px">Catch</div>
          <div class="field"><span>Shins angle</span><div class="bar"></div><span>—</span></div>
          <div class="field"><span>Forward body angle</span><div class="bar"></div><span>—</span></div>
          <div class="field"><span>Elbows unbent</span><div class="bar"></div><span>—</span></div>
        </div>

        <div class="disabled" style="margin-top:10px">
          <div style="font-weight:700;margin:6px 0 2px">Sequence</div>
          <div class="field"><span>Drive Legs&amp;Back separation</span><div class="bar"></div><span>—</span></div>
          <div class="field"><span>Drive Back&amp;Arms separation</span><div class="bar"></div><span>—</span></div>
          <div class="field"><span>Drive duration at stroke</span><div class="bar"></div><span>—</span></div>
        </div>
      </div>

      <div class="section">
        <h3>Athlete position</h3>
        <div class="mini"><canvas id="trace"></canvas></div>
      </div>
    </aside>
  </div>
</div>

<!-- Only external dependency -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<script>
/* ---------- DOM ---------- */
const video   = document.getElementById('video');
const playBtn = document.getElementById('play');
const speedEl = document.getElementById('speed');

const overlay = document.getElementById('overlay');
const octx    = overlay.getContext('2d');
const videoBox= document.getElementById('videoBox');

const track   = document.getElementById('track');
const thumb   = document.getElementById('thumb');
const clock   = document.getElementById('clock');

const gArc  = document.getElementById('gArc');
const gText = document.getElementById('gText');

const bLay=document.getElementById('bLay'), vLay=document.getElementById('vLay');
const bLeg=document.getElementById('bLeg'), vLeg=document.getElementById('vLeg');
const bHan=document.getElementById('bHan'), vHan=document.getElementById('vHan');

const trace = document.getElementById('trace');
const tctx  = trace.getContext('2d');

/* ---------- Canvas sizing ---------- */
function sizeCanvases(){
  const r = videoBox.getBoundingClientRect(), dpr = devicePixelRatio||1;
  overlay.width=Math.max(2,Math.round(r.width*dpr));
  overlay.height=Math.max(2,Math.round(r.height*dpr));
  overlay.style.width=r.width+'px'; overlay.style.height=r.height+'px';

  const tr = trace.getBoundingClientRect();
  trace.width=Math.max(2,Math.round(tr.width*dpr));
  trace.height=Math.max(2,Math.round(tr.height*dpr));
}
new ResizeObserver(sizeCanvases).observe(videoBox);
new ResizeObserver(sizeCanvases).observe(trace);

/* ---------- Simple stroke model (no external data) ---------- */
const W = 1920, H = 1080; // logical coords
const pairs = [['ankle','knee'],['knee','hip'],['hip','shoulder'],['shoulder','ear'],['shoulder','elbow'],['elbow','wrist'],['wrist','hand']];

function synthPoints(t){
  // 1.5s per stroke
  const phase = (t % 1.5) / 1.5;      // 0..1
  const cx = 980, cy = 620;
  const reach = 320, lift = 90;

  const handX = cx + reach * Math.sin(2*Math.PI*phase);
  const handY = cy  - lift  * Math.sin(4*Math.PI*phase + Math.PI/6);

  const baseY=720;
  const points = {
    ankle:{x:640,y:baseY},
    knee :{x:720,y:baseY-50},
    hip  :{x:800,y:baseY-90},
    shoulder:{x:940,y:baseY-170},
    ear:{x:980,y:baseY-210},
    elbow:{x:(handX+860)/2, y:(handY+baseY-150)/2},
    wrist:{x:(handX+920)/2, y:(handY+baseY-160)/2},
    hand:{x:handX,y:handY}
  };
  return points;
}

function drawSkeleton(points){
  const sx = overlay.width / W, sy = overlay.height / H;
  octx.clearRect(0,0,overlay.width,overlay.height);
  octx.lineWidth = 2; octx.strokeStyle = '#22c55e'; octx.fillStyle = '#2563eb';

  for (const [a,b] of pairs){
    if(points[a] && points[b]){
      octx.beginPath();
      octx.moveTo(points[a].x*sx, points[a].y*sy);
      octx.lineTo(points[b].x*sx, points[b].y*sy);
      octx.stroke();
    }
  }
  for (const k in points){
    const p=points[k]; octx.beginPath(); octx.arc(p.x*sx,p.y*sy,4,0,Math.PI*2); octx.fill();
  }
}

/* ---------- Gauge & right panel ---------- */
const CIRC = 2*Math.PI*52;
function setGauge(p){ // 0..1
  gArc.style.strokeDasharray=CIRC;
  gArc.style.strokeDashoffset = CIRC*(1-p);
  gText.textContent = Math.round(p*100)+'%';
}
function updateRight(t){
  const phase = (t % 1.5) / 1.5; // reuse
  setGauge(phase);

  const lay=32+16*Math.sin(t*1.2), legs=160+14*Math.sin(t*0.9+.7), hand=65+8*Math.sin(t*1.6+.3);
  bLay.style.width = Math.min(100,Math.max(0,(lay-20)/40*100))+'%'; vLay.textContent = lay.toFixed(0)+'°';
  bLeg.style.width = Math.min(100,Math.max(0,(legs-150)/40*100))+'%'; vLeg.textContent = legs.toFixed(0)+'°';
  bHan.style.width = Math.min(100,Math.max(0,(hand-55)/20*100))+'%'; vHan.textContent = hand.toFixed(0)+'%';
}

/* ---------- Status bar + mini trace ---------- */
const trail=[]; // last ~2s
function updateStatus(t, hand){
  const pct = (t % 8)/8*100;
  thumb.style.left = pct + '%';
  clock.textContent = t.toFixed(2)+'s';

  // mini trace
  trail.push({x:hand.x, y:hand.y, t});
  while (trail.length && t - trail[0].t > 2) trail.shift();

  tctx.clearRect(0,0,trace.width,trace.height);
  if (trail.length>1){
    const sx = trace.width/W, sy = trace.height/H;
    tctx.lineWidth=4; tctx.lineCap='round'; tctx.strokeStyle='#60a5fa';
    tctx.beginPath();
    tctx.moveTo(trail[0].x*sx, trail[0].y*sy);
    for(let i=1;i<trail.length;i++) tctx.lineTo(trail[i].x*sx, trail[i].y*sy);
    tctx.stroke();
  }
}

/* ---------- Chart (Speed & sequence) ---------- */
const seqCtx = document.getElementById('seq').getContext('2d');
const seqChart = new Chart(seqCtx,{
  type:'line',
  data:{datasets:[
    {label:'Legs',   data:[], borderColor:'#16a34a', tension:.35, pointRadius:0, borderWidth:2},
    {label:'Back',   data:[], borderColor:'#0ea5e9', tension:.35, pointRadius:0, borderWidth:2},
    {label:'Arms',   data:[], borderColor:'#f43f5e', tension:.35, pointRadius:0, borderWidth:2},
    {label:'Handle', data:[], borderColor:'#8b5cf6', tension:.35, pointRadius:0, borderWidth:2},
  ]},
  options:{
    animation:false, responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{
      x:{type:'linear', min:0, max:4, grid:{color:'#e5e7eb'}, ticks:{color:'#64748b'}},
      y:{min:-.1, max:1.2, grid:{color:'#e5e7eb'}, ticks:{color:'#64748b', stepSize:.5}}
    }
  }
});
let nextSample=0;
function updateSeq(t){
  const dt = 1/30;
  while(nextSample<=t){
    const ph = (nextSample % 1.5)/1.5;
    const bell = (x,c,w)=>Math.max(0,Math.sin(Math.PI*Math.min(1,Math.max(0,(x-c)/w))))**2;

    // simple overlapping bells
    const L = bell(ph, .18, .22);
    const B = bell(ph, .40, .22);
    const A = bell(ph, .65, .22);
    const H = (L*0.6 + B*0.7 + A*0.9); // proxy
    const x = nextSample;

    seqChart.data.datasets[0].data.push({x,y:L});
    seqChart.data.datasets[1].data.push({x,y:B});
    seqChart.data.datasets[2].data.push({x,y:A});
    seqChart.data.datasets[3].data.push({x,y:H});

    nextSample += dt;
  }
  const xmin = Math.max(0,t-4), xmax = xmin+4;
  seqChart.options.scales.x.min = xmin;
  seqChart.options.scales.x.max = xmax;

  // prune old points
  for(const ds of seqChart.data.datasets){
    while (ds.data.length && ds.data[0].x < xmin) ds.data.shift();
  }
  seqChart.update();
}

/* ---------- Animation engine (independent of video) ---------- */
let running = true, speed = 1.0;
let lastRAF = null, t = 0; // seconds

function loop(ts){
  if(!lastRAF) lastRAF = ts;
  const dt = (ts - lastRAF)/1000; lastRAF = ts;
  if (running) t += dt * speed;

  // compute synthetic pose
  const pts = synthPoints(t);
  drawSkeleton(pts);
  updateRight(t);
  updateStatus(t, pts.hand);
  updateSeq(t);

  requestAnimationFrame(loop);
}

/* ---------- Controls ---------- */
playBtn.addEventListener('click', ()=>{
  running = !running;
  if (running){ playBtn.textContent='⏸ Pause'; playBtn.classList.add('primary'); video.play().catch(()=>{}); }
  else { playBtn.textContent='▶ Play'; playBtn.classList.remove('primary'); video.pause(); }
});
speedEl.addEventListener('change', ()=>{
  speed = parseFloat(speedEl.value);
  video.playbackRate = speed;
});

/* ---------- Start ---------- */
sizeCanvases();
requestAnimationFrame(loop);
</script>
</body>
</html>
