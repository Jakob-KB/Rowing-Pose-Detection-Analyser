<!DOCTYPE html>
<meta charset="utf-8" />
<title>RowIO · Barebones Viewer (video→canvas)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body { margin: 12px; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  h1 { margin: 0 0 8px; font-size: 16px; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 8px 0; }
  input, button { padding: 6px 8px; }
  #list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; }
  .card { border: 1px solid #ccc; padding: 8px; }
  #viewer { margin-top: 12px; }
  #stage { display: block; width: 100%; background: #000; }
  #video { display: none; } /* hidden decode source */
  pre { background: #111; color: #eee; padding: 8px; overflow: auto; max-height: 40vh; }
</style>

<h1>RowIO · Sessions</h1>

<!-- Controls -->
<div class="row">
  <input id="name" placeholder="Session name" />
  <input id="path" placeholder="Absolute server filepath" />
  <button id="btnCreate">Create (POST)</button>
  <button id="btnRefresh">Refresh</button>
  <span id="msg">Idle.</span>
</div>

<!-- Sessions list -->
<h3>Sessions</h3>
<div id="list"></div>

<!-- Viewer -->
<section id="viewer" hidden>
  <div class="row" style="justify-content:space-between">
    <strong id="viewerTitle">Viewer</strong>
    <span id="viewerInfo">–</span>
  </div>

  <canvas id="stage"></canvas>
  <video id="video" playsinline crossorigin="anonymous"></video>

  <div class="row" style="margin-top:6px">
    <button id="btnToggle">▶ Play</button>
    <span id="frameInfo">–</span>
    <span id="drawInfo">–</span>
  </div>
</section>

<h3>Log</h3>
<pre id="out">(idle)</pre>

<script type="module">
  import { RowIOViewer } from './rowio-viewer.js';

  /* --------------------- Endpoints --------------------- */
  const BASE = "http://127.0.0.1:8000";
  const URL_SESSIONS = `${BASE}/rowio/sessions/`;
  const URL_SESSION = (id) => `${BASE}/rowio/sessions/${encodeURIComponent(id)}`;

  /* --------------------- Elements --------------------- */
  const OUT = document.getElementById('out');
  const MSG = document.getElementById('msg');
  const LIST = document.getElementById('list');
  const VIEWER = document.getElementById('viewer');
  const V_TITLE = document.getElementById('viewerTitle');
  const V_INFO = document.getElementById('viewerInfo');

  const VIDEO = document.getElementById('video');   // hidden source
  const STAGE = document.getElementById('stage');   // canvas

  const BTN_TOGGLE = document.getElementById('btnToggle');
  const FRAME_INFO = document.getElementById('frameInfo');
  const DRAW_INFO = document.getElementById('drawInfo');

  /* --------------------- Viewer instance --------------------- */
  const viewer = new RowIOViewer({
    canvas: STAGE,
    video: VIDEO,
    frameInfoEl: FRAME_INFO,
    drawInfoEl: DRAW_INFO,
    onLog: (s) => logln(s),
    onMsg: (s) => setMsg(s),
  });

  BTN_TOGGLE.onclick = () => {
    if (!VIDEO.src) return;
    if (VIDEO.paused) viewer.play(); else viewer.pause();
    BTN_TOGGLE.textContent = VIDEO.paused ? "▶ Play" : "⏸ Pause";
  };

  /* --------------------- Logging --------------------- */
  function logln(s){ OUT.textContent = `${OUT.textContent}\n${s}`.trimStart(); }
  function resetLog(title, url, init){
    OUT.textContent = `${title}\n${url}\n${JSON.stringify(init||{},null,2)}\n\n(waiting…)`;
  }
  function setMsg(s){ MSG.textContent = s; }

  /* --------------------- Fetch helper --------------------- */
  async function logFetch(label, url, init){
    resetLog(label, url, init);
    const res = await fetch(url, { mode: 'cors', cache: 'no-store', ...init });
    const body = await res.text();
    logln(`status: ${res.status}`);
    let data = null;
    try { data = JSON.parse(body); logln(JSON.stringify(data, null, 2)); }
    catch { logln(body); }
    return { res, data, text: data ? null : body };
  }

  /* --------------------- UI wiring --------------------- */
  document.getElementById('btnRefresh').onclick = loadSessions;
  document.getElementById('btnCreate').onclick = async () => {
    const name = document.getElementById('name').value.trim();
    const original_filepath = document.getElementById('path').value.trim();
    if (!name || !original_filepath){ setMsg("Enter name and path"); return; }
    const r = await logFetch("POST sessions", URL_SESSIONS, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ name, original_filepath }),
    });
    setMsg(r.res.ok ? "Created." : `Create failed: ${r.res.status}`);
    if (r.res.ok) loadSessions();
  };
  document.getElementById('name').addEventListener('keydown', e => { if (e.key === "Enter") document.getElementById('btnCreate').click(); });
  document.getElementById('path').addEventListener('keydown', e => { if (e.key === "Enter") document.getElementById('btnCreate').click(); });

  async function loadSessions(){
    LIST.innerHTML = "";
    const r = await logFetch("GET sessions", URL_SESSIONS, { headers: { Accept: "application/json" }});
    const items = Array.isArray(r.data) ? r.data : [];
    if (!items.length){ LIST.innerHTML = `<div>None.</div>`; return; }
    for (const s of items){
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div><strong>${esc(s?.name || '(untitled)')}</strong></div>
        <div>ID: ${esc(s?.id || '-')}</div>
        <div>Status: ${esc(s?.status || '-')}</div>
        <div style="margin-top:6px;display:flex;gap:8px;">
          <button class="btnGet" data-id="${attr(s?.id)}">GET JSON</button>
          <button class="btnPlay" data-id="${attr(s?.id)}" data-name="${attr(s?.name||s?.id||'Session')}">Play</button>
        </div>`;
      LIST.appendChild(el);
    }
    LIST.querySelectorAll('.btnGet').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        await logFetch(`GET session ${id}`, URL_SESSION(id), { headers: { Accept: "application/json" }});
      };
    });
    LIST.querySelectorAll('.btnPlay').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        const name = btn.getAttribute('data-name');
        await loadAndPlay(id, name);
      };
    });
  }

  /* --------------------- Play flow --------------------- */
  async function loadAndPlay(sessionId, displayName){
    const { res, data } = await logFetch(`GET session ${sessionId}`, URL_SESSION(sessionId), { headers: { Accept: "application/json" }});
    if (!res.ok){ setMsg(`GET failed: ${res.status}`); return; }

    const pv = data?.processed_video || {};
    const ev = data?.evaluation || {};
    const videoUrl = absURL(pv?.uri || pv?.path || "");
    const csvUrl   = absURL(ev?.uri || ev?.path || "");

    if (!videoUrl){ setMsg('No video url/path'); return; }

    document.getElementById('viewer').hidden = false;
    document.getElementById('viewerTitle').textContent = `Viewer · ${displayName || sessionId}`;
    document.getElementById('viewerInfo').textContent  = `video: ${videoUrl}${csvUrl ? ' | csv: '+csvUrl : ''}`;

    await viewer.load({ videoUrl, csvUrl, displayName });
    // Button label will update on first onplay
    BTN_TOGGLE.textContent = "⏸ Pause";
  }

  /* --------------------- Utils --------------------- */
  function absURL(u){
    if (!u) return "";
    if (/^https?:\/\//i.test(u)) return u;
    return BASE.replace(/\/+$/,'') + "/" + String(u).replace(/^\/+/, '');
  }
  function esc(str){ return String(str ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function attr(str){ return String(str ?? '').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }

  /* --------------------- Boot --------------------- */
  loadSessions().catch(e => setMsg(String(e)));
</script>
